---
import { ClientRouter } from 'astro:transitions';
import { Scanlines } from '../components/Scanlines';
import { TerminalHeader } from '../components/TerminalHeader';
import { TerminalFooter } from '../components/TerminalFooter';
import Navbar from '../components/Navbar.astro';
import '../styles/global.css';

interface Props {
	title?: string;
}

const { title = 'Terminal Scope' } = Astro.props;
const pathname = Astro.url.pathname;

// Calculate "command prompt" based on path
let command = 'echo "Hello World"';
if (pathname === '/') command = 'cat ~/dashboard.md';
else if (pathname.startsWith('/blog')) command = 'ls -l ~/blog';
else if (pathname.startsWith('/resources')) command = 'find ~/resources -type f';
else if (pathname === '/about') command = 'whoami';

// Parse breadcrumb path for clickable links
function getBreadcrumbPath() {
	if (pathname === '/') return { segments: [], currentPath: '/' };
	
	const segments = pathname.split('/').filter(Boolean);
	const currentPath = '/' + segments.join('/');
	return { segments, currentPath };
}

const { segments } = getBreadcrumbPath();

---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="Astro description" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
        <ClientRouter />
	</head>
	<body>
        <Scanlines client:load />
        
        <main id="terminal-main" class="w-full max-w-5xl relative z-10 flex flex-col shadow-2xl overflow-hidden md:rounded-lg md:border-2 bg-bg border-surface h-[90vh] min-h-[600px] mx-auto mt-0 md:mt-8">
            <TerminalHeader client:load />
            
            <div class="flex-1 overflow-y-auto p-4 md:p-8 relative scrollbar-thin scrollbar-thumb-surface scrollbar-track-transparent">
                <Navbar />
                
                {/* Fake Command Prompt */}
                <div class="mb-6 font-mono text-sm md:text-base h-8 flex items-center flex-wrap">
                     <a href="/" class="text-success hover:text-accent transition-colors cursor-pointer">visitor@site</a>
                     <span class="mx-1 opacity-50">:</span>
                     <span class="text-link">
                         {pathname === '/' ? (
                             <span>~</span>
                         ) : (
                             <>
                                 <a href="/" class="hover:text-accent transition-colors cursor-pointer">~</a>
                                 {segments.map((segment, index) => {
                                     const segmentPath = '/' + segments.slice(0, index + 1).join('/');
                                     const isLast = index === segments.length - 1;
                                     return (
                                         <>
                                             <span class="opacity-50">/</span>
                                             {isLast ? (
                                                 <span>{segment}</span>
                                             ) : (
                                                 <a href={segmentPath} class="hover:text-accent transition-colors cursor-pointer">{segment}</a>
                                             )}
                                         </>
                                     );
                                 })}
                             </>
                         )}
                     </span>
                     <span class="mx-1 opacity-50">$</span>
                     <span>{command}</span>
                     <span class="inline-block w-2 h-4 bg-text animate-pulse align-middle ml-1"></span>
                </div>

                <div class="animate-fade-in min-h-[400px]">
		            <slot />
                </div>
            </div>

            <TerminalFooter />
        </main>
        <script>
            // Sync maximize state from body to main element on every page
            const initMaximizeSync = () => {
                const main = document.getElementById('terminal-main');
                if (!main) return;

                const applyState = () => {
                    const isMaximized = document.body.getAttribute('data-maximized') === 'true';
                    if (isMaximized) {
                        main.setAttribute('data-maximized', 'true');
                    } else {
                        main.removeAttribute('data-maximized');
                    }
                };

                applyState();

                if (main.__maximizeObserver) {
                    main.__maximizeObserver.disconnect();
                }

                const observer = new MutationObserver(applyState);
                observer.observe(document.body, { attributes: true, attributeFilter: ['data-maximized'] });
                main.__maximizeObserver = observer;
            };

            document.addEventListener('DOMContentLoaded', initMaximizeSync);
            document.addEventListener('astro:page-load', initMaximizeSync);
        </script>
        <style>
            @media (min-width: 768px) {
                #terminal-main {
                    transition: none;
                }

                body[data-maximize-anim='true'] #terminal-main {
                    transition: all 0.3s ease;
                }

                #terminal-main[data-maximized='true'] {
                    position: fixed;
                    inset: 0;
                    max-width: none;
                    height: 100vh;
                    margin-top: 0;
                    border-radius: 0;
                }
            }
        </style>
	</body>
</html>

